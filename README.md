# 2025QC-Reservoir
リザバーコンピューティングの有効性評価のための検証支援業務

## 概要
国立研究開発法人新エネルギー・産業技術総合開発機構（NEDO）の「リザバーコンピューティング技術の有効性検証に関する技術調査事業」において、現場データを取得し有効性を評価するためのデータ作成と弊社が提供するライブラリを活用した分析の試行的実施を行う。

## 業務内容
リザバーコンピューティングの家庭用サービスロボット分野での活用の方法を検討し、検証用データの作成と弊社が提供するライブラリを活用した技術の有効性の評価を行う。

具体的には、以下の作業を行う。
- リザバーを用いた移動人物の経路予測プログラムの作成
- 家庭環境での従来手法との比較調査
- ＱｕａｎｔｕｍＣｏｒｅ社開発のライブラリの統合検討

## 成果物
- 検証結果報告書
- 検証用データ
- 検証用プログラム及びマニュアル　一式

## TID -> QC
[ROS 2 Leg Finder + Path Prediction (Dockerized)](https://gitlab.com/tidbots/path_prediction)

```
git clone --recursive git@github.com:tidbots/2025QC-Reservoir.git
```

## 評価経過

### ETHデータセットによる予測精度検証

ETH歩行者追跡データセット（ETH Zurich公開）を使用してESN経路予測の精度を評価。

#### 手法比較結果

| 手法 | 平均誤差 (m) | 備考 |
|------|-------------|------|
| **Kalman単体** | **0.509** | 直線軌道に最適 |
| Linear | 0.684 | 線形外挿 |
| V3 (Adaptive ESN) | 0.623 | 軌跡複雑度に応じた動的重み調整 |
| V2 (ESN+Kalman) | 0.753 | 固定重みハイブリッド |
| V1 (ESN only) | 0.901 | ESNアンサンブル |
| f(x) avg | 3.443 | RSJ2025 1I5-03の手法（不安定） |

#### バージョン間比較

| Version | 平均誤差 | vs V1 | vs V2 |
|---------|---------|-------|-------|
| V1 (ESN only) | 0.901m | - | - |
| V2 (Kalman Hybrid) | 0.753m | +16.4% | - |
| V3 (Adaptive) | 0.623m | +30.8% | +17.2% |

#### 複雑軌跡 vs 直線軌跡 比較

軌跡複雑度スコアにより歩行者を選別して比較：

| 手法 | 複雑軌跡 (m) | 直線軌跡 (m) |
|------|-------------|-------------|
| **Kalman** | **1.075** | **1.107** |
| V3 (Adaptive) | 1.523 | 1.188 |
| V2 (ESN+Kalman) | 1.903 | 1.309 |
| V1 (ESN) | 2.375 | 1.477 |

- 複雑軌跡: ped_ids 68, 90, 165, 399, 116（最大角度150°以上）
- 直線軌跡: ped_ids 280, 248, 249, 273, 87（最大角度30°未満）

#### 方向転換区間のみの評価（重要な発見）

ETHデータセットから方向転換フレーム（角度変化>20°）のみを抽出して評価。

| 区間 | Kalman | V3 | Best |
|------|--------|-----|------|
| **方向転換時** | 3.107 | **2.924** | **V3** |
| 非方向転換時 | **2.555** | 2.938 | **Kalman** |

#### パラメータチューニング

| パラメータ | 最適化前 | 最適化後 |
|-----------|---------|---------|
| units | 25 | **50** |
| spectral_radius | 0.8-0.9 | **0.90-0.98** |
| leaking_rate | 0.35-0.6 | **0.50-0.70** |
| input_scaling | 0.2-0.4 | **0.40-0.60** |

#### 予測ホライズン比較

| Horizon | Kalman | V3 (Hybrid) | 差 |
|---------|--------|-------------|-----|
| 20 | **1.93m** | 2.21m | -15% |
| 30 | **2.89m** | 3.34m | -16% |
| 40 | **3.91m** | 4.48m | -15% |
| 50 | **4.95m** | 5.70m | -15% |

#### ETH全データ評価（136人）

| 手法 | 平均誤差 (m) |
|------|-------------|
| **Kalman** | **1.184m** |
| V3 (Adaptive) | 1.316m |
| V2 (Fixed) | 1.504m |
| V1 (ESN) | 1.753m |

#### 最終結論

1. **ETHデータセットではKalmanが最良** - 歩行者の動きは本質的に線形
2. **V3はV1比24.9%改善** - ESNの適応学習とKalmanの安定性を組み合わせ
3. **ESNの限界** - 線形な動きに対しては過剰な複雑さ、ホライズン延長でも改善せず

#### ESNが有効になる可能性

- より非線形な動き（ロボット制御など）
- 繰り返しパターンを含むデータ
- 長期的な依存関係がある時系列

### 非線形軌跡データによる検証（重要な発見）

ETHの線形的な歩行者データではなく、より非線形な動きを含む合成データで検証を実施。

#### ESNがKalmanを上回ったケース

| 軌跡タイプ | Kalman | V3 | V1 | Best | 改善率 |
|-----------|--------|-----|-----|------|--------|
| **ローレンツ2D（カオス）** | 2.108 | 1.820 | **1.642** | V1 | **+22%** |
| **非線形振り子** | 14.087 | 11.796 | **10.706** | V1 | **+24%** |
| 二重正弦波 | 2.947 | **2.811** | 3.005 | V3 | +4.6% |
| バラ曲線 | 8.618 | **8.410** | 9.361 | V3 | +2.4% |

#### Kalmanが優位なケース

| 軌跡タイプ | Kalman | V3 | Linear | Best |
|-----------|--------|-----|--------|------|
| 円周（周期運動） | 0.871 | 1.229 | **0.569** | Linear |
| 正弦波 | 1.274 | 1.489 | **0.826** | Linear |
| 加減速 | 0.873 | 1.053 | **0.622** | Linear |

#### 結論

1. **カオス的なダイナミクス**（ローレンツアトラクタ）ではESN(V1)がKalmanを22%上回る
2. **非線形振動系**（大振幅の振り子）ではESN(V1)がKalmanを24%上回る
3. **周期的・線形的な動き**ではLinear外挿やKalmanが最適
4. **ESNの適応学習**はパターンの非線形性が高いほど効果を発揮

### 外乱応答テスト（重要な発見）

予測不能な外乱への応答能力を評価。

#### 外乱発生時の予測精度

| 外乱タイプ | Kalman | V3 | V1 | Best | 改善率 |
|-----------|--------|-----|-----|------|--------|
| **ランダム外力** | 3.471 | 3.037 | **2.892** | V1 | **+12.5%** |
| **速度バースト** | 0.721 | **0.674** | 0.678 | V3 | **+6.6%** |
| 突発障害物 | **0.704** | 1.647 | 2.747 | Kalman | - |
| 目標切替 | **0.634** | 0.919 | 1.263 | Kalman | - |
| 急停止・反転 | **0.552** | 0.647 | 0.769 | Kalman | - |

#### 結論

| 外乱タイプ | 特徴 | 最適手法 |
|-----------|------|---------|
| 連続的・ランダムな外力 | 予測不能だが連続的 | **ESN** |
| 突発的だが明確な変化 | 変化後は安定 | **Kalman** |

- **ESNの強み**: 連続的な外乱に対するオンライン適応学習
- **Kalmanの強み**: 状態変化後の安定した線形予測

### 評価ツール

```bash
# V1 vs V2 比較
python3 tools/eth_v1_v2_comparison.py --ped_ids 399 168 269 177 178

# V3 適応型ESN評価
python3 tools/eth_v3_adaptive.py --ped_ids 399 168 269 177 178

# 従来手法との比較
python3 tools/eth_method_comparison.py --ped_ids 399 168 269 177 178

# 非線形軌跡テスト
python3 tools/nonlinear_trajectory_test.py --n_trials 3 --future_horizon 20

# 外乱応答テスト
python3 tools/disturbance_response_test.py --n_trials 3 --future_horizon 20
```

### LSM (Liquid State Machine) との比較（重要な発見）

スパイキングニューラルネットワークベースのLSMとESNを比較。

#### 結果

| 軌跡タイプ | Kalman | ESN | LSM | Best | LSM vs ESN |
|-----------|--------|-----|-----|------|------------|
| Linear | **0.041** | 0.067 | 0.051 | Kalman | +24.5% |
| Circle | 0.871 | 1.836 | 1.701 | Linear | +7.4% |
| **Lorenz (カオス)** | 2.109 | 1.790 | **1.581** | **LSM** | **+11.7%** |
| **非線形振り子** | 14.085 | 18.665 | **9.734** | **LSM** | **+47.8%** |
| **Random Walk** | 0.788 | 1.155 | **0.775** | **LSM** | **+32.9%** |

#### ETHデータセットでのLSM評価

| 手法 | 平均誤差 | vs Kalman |
|-----|---------|-----------|
| **Kalman** | **0.971m** | - |
| LSM | 1.525m | -57.1% |
| ESN | 1.743m | -79.6% |

- ETH（線形歩行者）ではKalmanが最適
- **LSMはESNより12.5%改善**

#### 結論

- **LSMがESNを全ケースで上回る**（ETHで+12.5%、非線形振り子で+47.8%）
- **線形的な動き** → Kalman最適
- **非線形ダイナミクス** → LSM最適
- **スパイキングニューロン**の時間情報処理が効果的

```bash
# LSM vs ESN 比較
python3 tools/lsm_trajectory_test.py --n_trials 3 --future_horizon 20
```

## 総合評価結果

### 手法別最適用途

| 手法 | 特徴 | 最適な用途 |
|-----|------|-----------|
| **Kalman** | 速度ベース線形予測、低計算コスト | 歩行者予測、線形運動 |
| **ESN** | 連続値リザバー、オンライン適応 | 方向転換検出、連続外乱 |
| **LSM** | スパイキングリザバー、時間パターン | カオス系、非線形振動 |

### データタイプ別最適手法

| データタイプ | 1st | 2nd | 3rd | 備考 |
|-------------|-----|-----|-----|------|
| ETH歩行者（線形） | **Kalman** | LSM | ESN | Kalman=0.97m |
| 方向転換時 | **ESN(V3)** | Kalman | - | +5.9% vs Kalman |
| ランダム外力 | **ESN(V1)** | LSM | Kalman | +12.5% vs Kalman |
| ローレンツ（カオス） | **LSM** | ESN | Kalman | +25% vs Kalman |
| 非線形振り子 | **LSM** | Kalman | ESN | +31% vs Kalman |

### 主要な発見

1. **歩行者予測ではKalmanが最適** - 人間の動きは本質的に線形予測可能
2. **非線形ダイナミクスではLSMが最適** - カオス系で25%、非線形振動で31%改善
3. **LSMは全ケースでESNを上回る** - ETHで+12.5%、非線形振り子で+47.8%
4. **ESNは連続的外乱に強い** - ランダム外力で+12.5%改善

### 今後の課題

- QuantumCoreライブラリによるLSM/ESN高速化
- 実ロボット制御データでの検証
- ニューロモルフィックハードウェアへのLSM実装

## ドキュメント

詳細は [docs/](docs/) を参照してください。

- [path_prediction概要](docs/path_prediction.md) - システム概要
- [leg_finder詳細](docs/path_prediction_leg_finder.md) - 脚検出アルゴリズム
- [ESN経路予測詳細](docs/path_prediction_esn.md) - ESNアルゴリズム
- [デプロイメント](docs/path_prediction_deployment.md) - Docker設定
- [検証ツール](docs/path_prediction_tools.md) - ETHデータセット評価スクリプト
- [ETHデータセット評価](docs/path_prediction_eth_evaluation.md) - 予測精度の検証結果（V1/V2/V3比較含む）
- [V2改良検証](docs/path_prediction_v2_improvements.md) - カルマンハイブリッドの検証記録
