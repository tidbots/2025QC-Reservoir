# ESN経路予測 V2 改良検証

path_prediction_v2での予測精度改善に関する検証記録。

## 検証した改良アプローチ

### 1. リザバーサイズの拡大

**変更内容:**
- V1: 25ユニット ± 5
- V2: 50ユニット ± 8

**結果:** 精度悪化（-148%〜-313%）

**考察:**
- 大きなリザバーは学習データ量が不足
- RLS学習が収束しにくい
- より長いウォームアップ期間が必要

### 2. スペクトル半径の調整

**変更内容:**
- V1: 0.8-0.9
- V2: 0.88-0.95

**結果:** 不安定化

**考察:**
- 高いスペクトル半径はカオス的動作を引き起こす
- オンライン学習との相性が悪い

### 3. 方向転換検出の強化

**変更内容:**
```python
def _detect_direction_change(self):
    # 距離変化の検出
    dist_change = np.linalg.norm(v2 - v1)
    if dist_change > 0.15:
        return True

    # 角度変化の検出
    angle = np.arccos(cos_angle)
    if angle > 0.8:  # radians
        return True
```

**結果:** 一部改善の可能性

**考察:**
- 角度ベースの検出は有効
- しきい値の最適化が必要

### 4. 動的予測ホライズン

**変更内容:**
```python
def _compute_dynamic_horizon(self):
    if speed > 0.08 or speed_var > 0.005:
        return max(10, base_horizon - 5)  # 高速/不安定時は短く
    elif speed < 0.02:
        return min(30, base_horizon + 5)  # 低速時は長く
```

**結果:** 概念的には正しいが、他の変更との相互作用で効果不明

### 5. 適応学習のブースト機能

**変更内容:**
- 通常ダンピング: 0.5
- ブーストダンピング: 1.5
- エラー閾値超過時にブースト

**結果:** 学習の不安定化

## 検証結果サマリー

| パターン | V1誤差 | V2誤差 | 変化 |
|---------|--------|--------|------|
| straight | 0.208m | 0.516m | -148% |
| curve | 0.164m | 0.506m | -208% |
| zigzag | 0.252m | 0.473m | -88% |
| stop_and_go | 0.122m | 0.505m | -313% |

## 学んだ教訓

### 成功しなかった変更
1. **リザバーサイズの単純な拡大** - 学習データ不足で収束しない
2. **スペクトル半径の増加** - オンライン学習との相性が悪い
3. **適応学習率の増加** - 不安定化を招く

### 今後試すべきアプローチ
1. **漸進的な改良** - 1つずつ変更を適用して検証
2. **ウォームアップデータの増加** - 大きなリザバーには多くのデータが必要
3. **リッジ回帰の使用** - RLSの代わりにより安定した学習法
4. **入力特徴量の正規化改善** - より適切なスケーリング
5. **アンサンブル重み付け** - エラーベースでモデルを重み付け

## 推奨する次のステップ

### 短期的改善（低リスク）
1. 方向転換検出のしきい値チューニング
2. 適応学習率の微調整（0.35→0.4程度）
3. Savitzky-Golayウィンドウサイズの最適化

### 中期的改善（中リスク）
1. 入力特徴量の追加（速度のみ、加速度なし）
2. カルマンフィルタとのハイブリッド化
3. 予測ホライズンの動的調整

### 長期的改善（要研究）
1. 異なるリザバー構造（ESN以外）の検討
2. 深層学習ベースの予測器との比較
3. 実データでの評価

## ファイル構成

```
path_prediction_v2/
├── ros2_ws/src/esn_path_prediction/
│   └── esn_path_prediction.py  # オリジナル（変更なし）
tools/
├── esn_visualizer.py     # V1検証スクリプト
└── esn_visualizer_v2.py  # V2比較検証スクリプト
```

## 再現方法

```bash
# V1のみ検証
python3 tools/esn_visualizer.py --pattern all

# V1 vs V2比較
python3 tools/esn_visualizer_v2.py --pattern all
```
