# ESN経路予測 V2 改良検証

path_prediction_v2での予測精度改善に関する検証記録。

## 検証した改良アプローチ

### 1. リザバーサイズの拡大

**変更内容:**
- V1: 25ユニット ± 5
- V2: 50ユニット ± 8

**結果:** 精度悪化（-148%〜-313%）

**考察:**
- 大きなリザバーは学習データ量が不足
- RLS学習が収束しにくい
- より長いウォームアップ期間が必要

### 2. スペクトル半径の調整

**変更内容:**
- V1: 0.8-0.9
- V2: 0.88-0.95

**結果:** 不安定化

**考察:**
- 高いスペクトル半径はカオス的動作を引き起こす
- オンライン学習との相性が悪い

### 3. 方向転換検出の強化

**変更内容:**
```python
def _detect_direction_change(self):
    # 距離変化の検出
    dist_change = np.linalg.norm(v2 - v1)
    if dist_change > 0.15:
        return True

    # 角度変化の検出
    angle = np.arccos(cos_angle)
    if angle > 0.8:  # radians
        return True
```

**結果:** 一部改善の可能性

**考察:**
- 角度ベースの検出は有効
- しきい値の最適化が必要

### 4. 動的予測ホライズン

**変更内容:**
```python
def _compute_dynamic_horizon(self):
    if speed > 0.08 or speed_var > 0.005:
        return max(10, base_horizon - 5)  # 高速/不安定時は短く
    elif speed < 0.02:
        return min(30, base_horizon + 5)  # 低速時は長く
```

**結果:** 概念的には正しいが、他の変更との相互作用で効果不明

### 5. 適応学習のブースト機能

**変更内容:**
- 通常ダンピング: 0.5
- ブーストダンピング: 1.5
- エラー閾値超過時にブースト

**結果:** 学習の不安定化

## 検証結果サマリー

| パターン | V1誤差 | V2誤差 | 変化 |
|---------|--------|--------|------|
| straight | 0.208m | 0.516m | -148% |
| curve | 0.164m | 0.506m | -208% |
| zigzag | 0.252m | 0.473m | -88% |
| stop_and_go | 0.122m | 0.505m | -313% |

## 学んだ教訓

### 成功しなかった変更
1. **リザバーサイズの単純な拡大** - 学習データ不足で収束しない
2. **スペクトル半径の増加** - オンライン学習との相性が悪い
3. **適応学習率の増加** - 不安定化を招く

### 今後試すべきアプローチ
1. **漸進的な改良** - 1つずつ変更を適用して検証
2. **ウォームアップデータの増加** - 大きなリザバーには多くのデータが必要
3. **リッジ回帰の使用** - RLSの代わりにより安定した学習法
4. **入力特徴量の正規化改善** - より適切なスケーリング
5. **アンサンブル重み付け** - エラーベースでモデルを重み付け

## 漸進的改良の検証結果（2024年2月）

推奨されたアプローチを1つずつ検証した結果。

### 6. 方向転換検出のしきい値チューニング

**変更内容:**
```python
def _detect_direction_change(self):
    # 速度変化の検出（しきい値: 0.08）
    if abs(norm2 - norm1) > self.speed_thresh:
        return True
    # 角度変化の検出（しきい値: 0.5 radians）
    if np.arccos(cos_angle) > self.angle_thresh:
        return True
```

**結果:** 平均 -9.3%（悪化）

| パターン | V1誤差 | Direction Tuned | 変化 |
|---------|--------|-----------------|------|
| straight | 0.140m | 0.177m | -26% |
| curve | 0.154m | 0.172m | -11% |
| zigzag | 0.272m | 0.296m | -9% |
| stop_and_go | 0.190m | 0.172m | +9% |

**考察:**
- stop_and_goパターンでのみ改善
- 他のパターンでは悪化
- しきい値のさらなる最適化が必要

### 7. カルマンフィルタとのハイブリッド化

**変更内容:**
```python
class SimpleKalmanFilter:
    """2D位置追跡用カルマンフィルタ - 状態: [x, y, vx, vy]"""
    def __init__(self, dt=0.1, process_noise=0.1, measurement_noise=0.05):
        # 状態遷移行列、観測行列、共分散行列

class KalmanHybridESNPredictor:
    """ESN + カルマンフィルタのハイブリッド"""
    # 重み付け組み合わせ: (1 - kalman_weight) * esn_pred + kalman_weight * kalman_pred
    # kalman_weight = 0.3
```

**結果:** 平均 **+18.8%**（改善）✓

| パターン | V1誤差 | Kalman Hybrid | 変化 |
|---------|--------|---------------|------|
| straight | 0.140m | 0.123m | **+12%** |
| curve | 0.154m | 0.112m | **+27%** |
| zigzag | 0.272m | 0.245m | **+10%** |
| stop_and_go | 0.190m | 0.139m | **+26%** |

**考察:**
- 全パターンで改善
- curveとstop_and_goで特に効果的
- カルマンフィルタの平滑化効果が有効
- **推奨アプローチとして採用**

### 8. 方向転換検出 + カルマンハイブリッドの組み合わせ

**変更内容:**
- 方向転換検出のしきい値チューニング
- カルマンフィルタハイブリッド
- 両方を組み合わせ

**結果:** 平均 +12.7%（改善）

| パターン | V1誤差 | Combined | 変化 |
|---------|--------|----------|------|
| straight | 0.140m | 0.147m | -5% |
| curve | 0.154m | 0.124m | +20% |
| zigzag | 0.272m | 0.262m | +4% |
| stop_and_go | 0.190m | 0.128m | **+33%** |

**考察:**
- stop_and_goで最高の改善
- straightでわずかに悪化
- カルマンハイブリッド単体より効果は低い
- 方向転換検出が一部パターンに干渉

## 漸進的改良サマリー

| アプローチ | 平均改善率 | 推奨 |
|-----------|-----------|------|
| Direction Tuned | -9.3% | ✗ |
| **Kalman Hybrid** | **+18.8%** | **✓** |
| Combined | +12.7% | △ |

**結論:** カルマンフィルタとのハイブリッドアプローチが最も効果的。

## 今後の推奨ステップ

### 短期的改善（低リスク）
1. ~~方向転換検出のしきい値チューニング~~ → 効果限定的
2. **カルマンフィルタハイブリッドの適用** → 推奨
3. カルマンフィルタの重みパラメータ最適化（現在0.3）

### 中期的改善（中リスク）
1. 入力特徴量の追加（速度のみ、加速度なし）
2. 予測ホライズンの動的調整
3. パターン別の重み自動調整

### 長期的改善（要研究）
1. 異なるリザバー構造（ESN以外）の検討
2. 深層学習ベースの予測器との比較
3. 実データでの評価

## ファイル構成

```
path_prediction_v2/
├── ros2_ws/src/esn_path_prediction/
│   └── esn_path_prediction.py  # オリジナル（変更なし）
tools/
├── esn_visualizer.py       # V1検証スクリプト
├── esn_visualizer_v2.py    # V2比較検証スクリプト
└── esn_improvement_test.py # 漸進的改良検証スクリプト
output/
└── esn_improvements_*.png  # 改良検証結果の可視化
```

## 再現方法

```bash
# V1のみ検証
python3 tools/esn_visualizer.py --pattern all

# V1 vs V2比較
python3 tools/esn_visualizer_v2.py --pattern all

# 漸進的改良検証
python3 tools/esn_improvement_test.py --output output
```
